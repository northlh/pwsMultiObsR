---
title: "example01_default"
author: "Lauren North"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{example01_default}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# 1 Setup Directories

## 1.1 Setup root directory
This notebook is designed to run an example pywatershed model with no user intervention (run all). If you encounter errors in running the model, it is recommended to re-run this chunk to reset the environment/directories since they can get jumbled by the python calls.

```{r setup}

rm(list = ls()) # Clear Environment
devtools::load_all() # FOR DEV

#library(pwsMultiObsR)
#ls("package:pwsMultiObsR")

dir_root <- file.path("/Users/lnorth/Desktop/test_pwsMultiObsR")
project_name <- "test_east"

```

## 1.2 Create Project
This function uses one argument, a character string as the project name of your choice. It will create a parent folder called "Projects" and then create your project folder within that. This is intended to represent one basin or can be used to manage directories for experiments.

```{r setup}

?pwsMultiObsR::fm_project_create

dir_project <- fm_project_create(dir_root = dir_root,
                                 project_name = project_name)

```

## 1.3 Create Trial
*STOP:*
You must add files to the "default_input" directory that was just created in the project folder. This includes:
      • myparam.param
      • control.control
      • prcp.cbh
      • tmax.cbh
      • tmin.cbh

*For this example:*
In the main directory is a folder called "EastRiv_example_defaults" which contains all necessary files for a run. The control_default.control file is specific to this default run. All contents will be automatically moved over by the function below, but this will need to be done manually in all other projects.

NOTE:
The climate-by-HRU (.cbh) files are the same as the .day files received from the NHM. They need to be renamed to the names above to be compatible with pws. USGS collaborators have provided CBH files as they are clipped from the NHM - they are interpolated from the 1km gridded daymet dataset: https://pubs.usgs.gov/tm/06/b09/tm6b9.pdf. They may be able to be generated using the PRMS legacy edition, see page 86 of PRMS-IV documentation https://pubs.usgs.gov/tm/6b7/pdf/tm6-b7.pdf.

```{r User Input, warning=TRUE}

# Function to copy the files from the example GIS and default dirs
pws.load.example.files(wd = here(),
                       project_name = "day_EastRiv")

```

The function below creates a "trial" which is essentially a sub directory within the project. The intent of the trials is to have the default runs and sensitivity/uncertainty runs belong to the same project, and thus observations, GIS, default inputs, etc..

NOTE:
There should only be one default run per project. The folder for project_name/output/trial_001 will be empty because the default results are stored in the default_output directory. Future developments include forcing the first trial to be default, overwrite protection, and providing an option to do other "default" experiments without interfering with the true default.

```{r setup}

?pwsMultiObsR::fm_trial_create

directories <- fm_trial_create(
  dir_root = dir_root,
  project_name = project_name,
  type = "default"
)

# # If you have already created the trial and want to come back to it, use this:
# 
# directories <- fm_trial_set(
#   dir_root = dir_root,
#   project_name = project_name,
#   trial_number = 1
# )

```

## 2 Load Observations

# 2,1 View SNOTEL and USGS Stations
*For this example:*
In the main directory is a folder called "EastRiv_example_GIS" which contains all necessary files for the following functions. These files are clips from the NHM, received from USGS collaborators. The files were automatically moved over by pws.load.example.files, but this will need to be done manually in all other projects. 

```{r setup}

plot_snotel(dir_root = dir_root, project_name = project_name)

plot_usgs(dir_root = dir_root, project_name = project_name)

```

# 2.2 Align Stations with the Model
You'll notice that some of the SNOTEL stations lie close to an HRU border, an overall basin boundary, or that the NHM segments are unclear. You will need to do some additional investigation for these stations to determine which model HRU or segment they belong to. Once you have determined your observation network, write the stations into a list as shown in the following chunk. This has already been completed for this example.

See the NRCS iMap to view SNOTEL gauges and their site IDs: https://www.nrcs.usda.gov/programs-initiatives/sswsf-snow-survey-and-water-supply-forecasting-program/national-water-and

```{r setup}

# EAST RIVER
nrcs_stations <- list(CO = list(site_ids = c(380, 737),
                                  hru_ids = c(8,10)))

usgs_stations <- list(site_ids = c("09112500", "09112200"),
                      seg_ids = c(5,4))

```

## 2.3  Read in SNOTEL data
This function uses a url connection, and times out at 60 seconds which may require more than one attempt if internet is slow. Currently it is hard-coded to only extract SWE and soil moisture, but it can do all others. It will extract for the full length of available record.

```{r Read Observations, warning=TRUE}

nrcs_data <- retrieve_nrcs(
  dir_root = dir_root,
  project_name = project_name,
  nrcs_stations = nrcs_stations,
  overwrite = FALSE)

```

## 2.4 Read in USGS data
This function is relatively fast, using the DataRetrieval package. It requires a date range for the readNWIS function (okay to overshoot period of record).

```{r Read Observations, warning=TRUE}

usgs_data <- retrieve_q(
  dir_root = dir_root,
  project_name = project_name,
  usgs_stations = usgs_stations,
  start_date = "1970-10-01",
  end_date = "2023-09-30",
  overwrite = FALSE)

```

# 3 Run Model
If you run into errors here, be sure to reset the working directory bu running the first chunk before trying again. Troubleshooting steps may involve checking the filenames in the default_input directory, checking some of the variables or file calls in the control file, or checking your python or pywatershed installation. A default run may take several minutes depending on you machine and modeling domain. In this example, we run (43 yrs) of the 10 HRU East River watershed using default inputs from the NHM.

```{r Run Model, warning=TRUE}

?run_default

run_default(dir_root = dir_root,
            project_name = project_name,
            trial_number = directories$trial_number)


```

# 4 Analyze Output
The function pws.analyze.output post-processes the model results. It is currently setup to run daily mean SWE and discharge. It writes goodness of fit (GOF) results in lists named "list_GOF_x" into the environment and saves them in the output directory.

```{r setup}
?calc_gof

gof_results <- calc_gof(
  dir_root = dir_root,
  project_name = project_name,
  trial_number = directories$trial_number,
  start_year = 1982,
  end_year = 2022,
  hru_out_names = "pkwater_equiv",
  seg_out_names = "seg_outflow",
  default = TRUE
)

```



